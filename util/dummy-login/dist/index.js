(()=>{"use strict";var e={152:function(e,r,o){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:true});r.runLoginProxyServer=r.runLoginCallbackServer=void 0;const t=s(o(685));const n=s(o(477));const a=o(837);const runServerImpl=async(e,r)=>new Promise(((o,s)=>{const n=t.default.createServer(((e,o)=>{r(e,o).then((()=>o.end())).catch((e=>{if(e instanceof ErrorResponse){o.writeHead(e.code);if(e.body){o.write(e.body)}}else{o.writeHead(c.INTERNAL_SERVER_ERROR);o.write("Internal server error")}o.end()}))}));n.on("listening",(()=>{if(e.onListen==null){console.log("Listening on: ",e.listen)}else{e.onListen()}}));n.on("error",s);n.on("close",o);if("socketPath"in e.listen){n.listen(e.listen.socketPath)}else{n.listen(e.listen.port,e.listen.host)}}));class ErrorResponse{constructor(e,r){this.code=e;this.body=r}}const runLoginCallbackServer=async e=>runServerImpl(e,((r,o)=>loginCallbackHandler(r,o,e)));r.runLoginCallbackServer=runLoginCallbackServer;const loginCallbackHandler=async(e,r,{check:o})=>{var s;if(e.method!=="POST"){throw new ErrorResponse(c.METHOD_NOT_ALLOWED)}if(!((s=e.headers["content-type"])===null||s===void 0?void 0:s.startsWith("application/json"))){throw new ErrorResponse(c.BAD_REQUEST,"incorrect content type")}const t=await downloadBody(e);let n;let a;try{const e=JSON.parse(t);n=e["userid"];a=e["password"]}catch(e){throw new ErrorResponse(c.BAD_REQUEST,"Invalid JSON request body")}if(n==null||a==null){throw new ErrorResponse(c.BAD_REQUEST,"Missing fields in body")}let i;try{i=await o({userid:n,password:a})}catch(e){console.error("Login check threw an exception: ",e);r.writeHead(c.INTERNAL_SERVER_ERROR);return}r.writeHead(200,{"Content-Type":"application/json"});if(i==="forbidden"){r.end(JSON.stringify({outcome:"no-user"}))}else{r.end(JSON.stringify({outcome:"user",...i}))}};const runLoginProxyServer=async e=>runServerImpl(e,((r,o)=>loginProxyHandler(r,o,e)));r.runLoginProxyServer=runLoginProxyServer;const i="userid";const l="password";const loginProxyHandler=async(e,r,{check:o,tobira:s})=>{var a;if(e.method!=="POST"){throw new ErrorResponse(c.METHOD_NOT_ALLOWED)}if(!((a=e.headers["content-type"])===null||a===void 0?void 0:a.startsWith("application/x-www-form-urlencoded"))){throw new ErrorResponse(c.BAD_REQUEST,"incorrect content type")}const d=await downloadBody(e);const _=n.default.parse(d);const[u,R]=[i,l].map((e=>{const r=_[e];if(typeof r==="string"){return r}else{if((r===null||r===void 0?void 0:r.length)!==1){throw new ErrorResponse(c.BAD_REQUEST,`field ${e} not present exactly once`)}return r[0]}}));let E;try{E=await o({userid:u,password:R})}catch(e){console.error("Login check threw an exception: ",e);r.writeHead(c.INTERNAL_SERVER_ERROR);return}if(E==="forbidden"){r.writeHead(c.FORBIDDEN)}else{const{username:e,displayName:o,roles:n,userRole:a,email:i}=E;n.push(a);const b64encode=e=>Buffer.from(e).toString("base64");let l;try{l=await new Promise(((r,a)=>{const l={...s!==null&&s!==void 0?s:{host:"localhost",port:3080},path:"/~session",method:"POST",headers:{"x-tobira-username":b64encode(e),"x-tobira-user-display-name":b64encode(o),"x-tobira-user-roles":b64encode(n.join(",")),...i&&{"x-tobira-user-email":b64encode(i)}}};const c=t.default.request(l);c.on("response",r);c.on("error",a);c.end()}))}catch(e){console.error("Failed to create user session:",e);r.writeHead(c.BAD_GATEWAY);return}if(l.statusCode!==c.NO_CONTENT){console.warn("unexpected status code from 'POST /~session'")}r.writeHead(c.NO_CONTENT,{"set-cookie":l.headers["set-cookie"]})}};const downloadBody=async e=>{const r=await new Promise(((r,o)=>{const s=[];e.on("data",(e=>s.push(e)));e.on("end",(()=>r(Buffer.concat(s))));e.on("error",o)}));const o=new a.TextDecoder("utf8",{fatal:true});try{return o.decode(r)}catch(e){throw new ErrorResponse(c.BAD_REQUEST,"Request body is not valid UTF-8")}};const c={NO_CONTENT:204,BAD_REQUEST:400,FORBIDDEN:403,METHOD_NOT_ALLOWED:405,INTERNAL_SERVER_ERROR:500,BAD_GATEWAY:502}},177:function(e,r,o){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:true});const t=s(o(292));const n=o(152);const main=async()=>{let e;if(process.argv[2]){const r=process.argv[2];const o=`/opt/tobira/${r}/socket/auth.sock`;await t.default.rm(o,{force:true});e={socketPath:o}}else{e={host:"0.0.0.0",port:3091}}process.on("SIGTERM",(()=>process.exit(0)));try{await(0,n.runLoginCallbackServer)({listen:e,check:check,onListen:()=>{console.log("Listening on:",e);if("socketPath"in e){t.default.chmod(e.socketPath,511).catch((e=>console.warn("could not chmod socket file",e)))}}})}catch(e){console.log(e)}};const check=async({userid:e,password:r})=>{const o=i[e];const s=process.argv[2]&&(o===null||o===void 0?void 0:o.properPassword)?process.env.TOBIRA_ADMIN_PASSWORD:a;if(!s){console.error("Tobira admin password env not set!");return"forbidden"}if(r===s&&o){return{username:e,displayName:o.displayName,userRole:o.userRole,roles:o.roles.concat(["ROLE_ANONYMOUS","ROLE_USER"]),email:o.email,userRealmHandle:o.userRealmHandle}}else{console.log(`Invalid login ${e}:${r}`);return"forbidden"}};const a="tobira";const i={admin:{displayName:"Administrator",userRole:"ROLE_USER_ADMIN",roles:["ROLE_ADMIN","ROLE_SUDO"],email:"admin@example.org",properPassword:true},tobiradmin:{displayName:"Tobira Admin",userRole:"ROLE_USER_TOBIRADMIN",roles:["ROLE_TOBIRA_ADMIN"],email:"tobiradmin@example.org",properPassword:true},gustav:{displayName:"Gustav Mahler",userRole:"ROLE_USER_GUSTAV",roles:["ROLE_INSTRUCTOR","ROLE_TOBIRA_GLOBAL_PAGE_ADMIN"],properPassword:true},sabine:{displayName:"Sabine Rudolfs",userRole:"ROLE_USER_SABINE",roles:["ROLE_INSTRUCTOR","ROLE_STAFF","ROLE_TOBIRA_CAN_FIND_UNLISTED","ROLE_TOBIRA_UPLOAD","ROLE_TOBIRA_STUDIO","ROLE_TOBIRA_CAN_CREATE_SERIES"],email:"sabine@example.org"},"björk":{displayName:"Prof. Björk Guðmundsdóttir",userRole:"ROLE_USER_BJOERK",roles:["ROLE_EXTERNAL","ROLE_TOBIRA_CAN_FIND_UNLISTED","ROLE_TOBIRA_UPLOAD","ROLE_TOBIRA_STUDIO","ROLE_TOBIRA_CAN_CREATE_SERIES"],email:"bjoerk@example.org",userRealmHandle:"bjorky"},morgan:{displayName:"Morgan Yu",userRole:"ROLE_USER_MORGAN",roles:["ROLE_STUDENT","ROLE_TOBIRA_UPLOAD"],email:"morgan@example.org"},jose:{displayName:"José Carreño Quiñones",userRole:"ROLE_USER_JOSE",roles:["ROLE_STUDENT"]}};main()},292:e=>{e.exports=require("fs/promises")},685:e=>{e.exports=require("http")},477:e=>{e.exports=require("querystring")},837:e=>{e.exports=require("util")}};var r={};function __nccwpck_require__(o){var s=r[o];if(s!==undefined){return s.exports}var t=r[o]={exports:{}};var n=true;try{e[o].call(t.exports,t,t.exports,__nccwpck_require__);n=false}finally{if(n)delete r[o]}return t.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var o=__nccwpck_require__(177);module.exports=o})();